# Template file for 'uboot-pine64'
# Adapted from https://github.com/dreemurrs-embedded/Pine64-Arch/blob/master/PKGBUILDS/pine64/uboot-pinephone/PKGBUILD

pkgname=uboot-pine64
version=2020.10
revision=1
_fullver=v${pkgver}_rc3
archs="aarch64 aarch64-musl"
_commit_uboot="7206996ef7f89375dd74b275ced62d85f8bc7f42"
_commit_atf="f928897fa5df6afa0f70bb1b1011e4bb03cb4596"
conf_files="/boot/boot.txt"
hostmakedepends="bc python swig dtc"
depends="uboot-mkimage"
homepage="http://www.denx.de/wiki/U-Boot/WebHome"
license="GPL-2.0-or-later"
distfiles="https://gitlab.com/pine64-org/u-boot/-/archive/${_commit_uboot}/u-boot-${_commit_uboot}.tar.gz
	https://github.com/crust-firmware/arm-trusted-firmware/archive/${_commit_atf}.tar.gz"

do_build() {	
	cd "arm-trusted-firmware-${_commit_atf}"
	make PLAT=sun50i_a64 DEBUG=1 bl31
	cp build/sun50i_a64/debug/bl31.bin "../u-boot-${_commit_uboot}"

	cd "../u-boot-${_commit_uboot}"
	make distclean
	make pinetab_defconfig

	cat << EOF >> .config
CONFIG_IDENT_STRING="ExpidusOS Willamette v0.1.0-prealpha"
CONFIG_SERIAL_PRESENT=y
CONFIG_GZIP=y
CONFIG_CMD_UNZIP=y
CONFIG_CMD_EXT4=y
CONFIG_SUPPORT_RAW_INITRD=y
CONFIG_CMD_EXT4_WRITE=n
CONFIG_EXT4_WRITE=n
EOF

	make EXTRAVERSION=-${revision}
	cat spl/sunxi-spl.bin u-boot.itb > u-boot-sunxi-with-spl-pinetab-624.bin

	echo 'CONFIG_DRAM_CLK=552' >> .config
	make EXTRAVERSION=-${revision}
	cat spl/sunxi-spl.bin u-boot.itb > u-boot-sunxi-with-spl-pinetab-552.bin

	echo 'CONFIG_DRAM_CLK=492' >> .config
	make EXTRAVERSION=-${revision}
	cat spl/sunxi-spl.bin u-boot.itb > u-boot-sunxi-with-spl-pinetab-492.bin

	make pinephone_defconfig

	cat << EOF >> .config
CONFIG_IDENT_STRING="ExpidusOS Willamette v0.1.0-prealpha"
CONFIG_SERIAL_PRESENT=y
CONFIG_GZIP=y
CONFIG_CMD_UNZIP=y
CONFIG_CMD_EXT4=y
CONFIG_SUPPORT_RAW_INITRD=y
CONFIG_CMD_EXT4_WRITE=n
CONFIG_EXT4_WRITE=n
CONFIG_DRAM_CLK=624
EOF
	make EXTRAVERSION=-${revision}
	cat spl/sunxi-spl.bin u-boot.itb > u-boot-sunxi-with-spl-pinephone-624.bin

	echo 'CONFIG_DRAM_CLK=552' >> .config
	make EXTRAVERSION=-${revision}
	cat spl/sunxi-spl.bin u-boot.itb > u-boot-sunxi-with-spl-pinephone-552.bin

	echo 'CONFIG_DRAM_CLK=492' >> .config
	make EXTRAVERSION=-${revision}
	cat spl/sunxi-spl.bin u-boot.itb > u-boot-sunxi-with-spl-pinephone-492.bin
}

do_install() {
	mkdir -p "${DESTDIR}/boot"
	cp u-boot-sunxi-with-spl-pine{tab,phone}-{624,552,492}.bin ${DESTDIR}/boot
	cp "${FILESDIR}/boot.txt" "${DESTDIR}/boot/boot.txt"
}
